<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>条形码和二维码生成器</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f3f4f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 480px;
        }

        h1 {
            color: #4CAF50;
            font-size: 2rem;
            margin-bottom: 15px;
        }

        p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 20px;
        }

        input[type="text"] {
            padding: 12px 16px;
            font-size: 1rem;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        button {
            padding: 12px 20px;
            font-size: 1.1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            max-width: 400px;
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        #barcode, #qrcode {
            margin-top: 30px;
        }

        #barcode svg, #qrcode canvas {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }

        .info-text {
            font-size: 0.9rem;
            color: #777;
            margin-top: 10px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            margin: 10px 5px;
            transition: background-color 0.3s ease;
        }

        .tab:hover {
            background-color: #45a049;
        }

        .hidden {
            display: none;
        }

        /* 针对暗黑模式的自定义样式 */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }

            .container {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }

            #barcode svg {
                background-color: transparent;
            }

            #barcode svg rect {
                fill: #ffffff;
            }

            button {
                background-color: #6200ea;
            }

            #qrcode canvas {
                background: transparent;
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>条形码和二维码生成器</h1>
        
        <!-- Tab buttons -->
        <button class="tab" onclick="showSection('generateSection')">生成条形码和二维码</button>
        <button class="tab" onclick="showSection('parseSection')">二维码解析</button>

        <!-- 生成条形码和二维码的部分 -->
        <div id="generateSection">
            <p>请输入文本或网址：</p>
            <div class="input-group">
                <input type="text" id="inputText" placeholder="输入文本或网址" />
            </div>
            <button onclick="generateCodes()">生成条形码和二维码</button>

            <div id="barcode">
                <svg></svg>  <!-- 条形码 SVG -->
            </div>

            <div id="qrcode">
                <canvas></canvas> <!-- 二维码 Canvas -->
            </div>

            <div class="info-text">
                <p>注意：条形码将基于输入文本的哈希值生成。</p>
            </div>
        </div>

        <!-- 二维码解析的部分 -->
        <div id="parseSection" class="hidden">
            <h2>二维码解析</h2>
            <input type="file" id="qrInput" accept="image/*">
            <div class="output">
                <p>解析结果:</p>
                <p id="qrResult">请上传一个二维码图片</p>
            </div>
        </div>

    </div>

    <script>
        // 显示指定的部分
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.container > div');
            sections.forEach(section => {
                section.classList.add('hidden'); // 隐藏所有部分
            });
            document.getElementById(sectionId).classList.remove('hidden'); // 显示指定部分
        }

        // 计算EAN-13检验位
        function calculateCheckDigit(number) {
            let total = 0;
            for (let i = 0; i < 12; i++) {
                let digit = parseInt(number.charAt(i));
                total += (i % 2 === 0) ? digit : digit * 3; // 奇数位加权1，偶数位加权3
            }
            let checkDigit = (10 - (total % 10)) % 10; // 计算检验位
            return checkDigit;
        }

        // 生成条形码和二维码
        function generateCodes() {
            const inputText = document.getElementById('inputText').value;
            if (!inputText) {
                alert('请输入文本或网址');
                return;
            }

            // 获取当前的颜色模式（判断是否为暗黑模式）
            const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            // 设置二维码的前景和背景颜色
            const qrOptions = {
                errorCorrectionLevel: 'H',
                background: isDarkMode ? '#000000' : '#ffffff', // 黑底或白底
                foreground: isDarkMode ? '#ffffff' : '#000000', // 白码或黑码
                width: 256,  // 设置二维码宽度
                height: 256  // 设置二维码高度
            };

            // 使用QRCode.js生成二维码
            const canvas = document.querySelector('#qrcode canvas');  // 获取canvas元素
            QRCode.toCanvas(canvas, inputText, qrOptions, function (error) {
                if (error) {
                    console.error(error);
                    alert('二维码生成失败');
                } else {
                    console.log('二维码生成成功!');
                }
            });

            // 使用输入的文本生成12位数字
            let hash = 0;
            for (let i = 0; i < inputText.length; i++) {
                hash = (hash << 5) - hash + inputText.charCodeAt(i); // 基于字符码计算哈希值
                hash = hash & hash; // 确保是32位整数
            }

            let number = Math.abs(hash).toString().padStart(12, '0').slice(0, 12); // 获取12位数字
            let checkDigit = calculateCheckDigit(number); // 计算检验位
            let fullBarcode = number + checkDigit; // 完整的12位数字+检验位

            // 使用JsBarcode生成条形码
            console.log('生成条形码:', fullBarcode);
            JsBarcode("#barcode svg", fullBarcode, {
                format: "EAN13",
                displayValue: true,
                fontSize: 20,
                lineColor: "#000",  // 使用黑色来确保条形码清晰
                background: "transparent", // 背景透明
                width: 2,
                height: 100
            });
        }

        // 二维码解析
        document.getElementById('qrInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('请上传一个文件');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // 读取二维码
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, canvas.width, canvas.height);

                    if (code) {
                        document.getElementById('qrResult').textContent = '二维码内容: ' + code.data;
                    } else {
                        document.getElementById('qrResult').textContent = '无法识别二维码';
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // 默认显示条形码生成部分
        showSection('generateSection');
    </script>

</body>
</html>